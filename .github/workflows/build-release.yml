name: æ­£å¼ç‰ˆæ„å»º

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string
      create_release:
        description: 'æ˜¯å¦åˆ›å»º GitHub Release'
        required: true
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  # ------------ æå‰å‡†å¤‡ï¼ˆè¯»å–åŒ…å & ç‰ˆæœ¬å·ï¼‰ ------------
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      pkg: ${{ steps.pkg.outputs.pkg }}
      pkg_capitalized: ${{ steps.pkg_capitalized.outputs.pkg_capitalized }}
      version: ${{ steps.ver.outputs.version }}
      tag: ${{ steps.tag.outputs.tag }}
      changelog: ${{ steps.changelog.outputs.changelog }}
      mihomo_version: ${{ steps.get_mihomo_version.outputs.version }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: è¯»å– pubspec.yaml åŒ…å
        id: pkg
        run: |
          pkg=$(grep '^name:' pubspec.yaml | awk '{print $2}')
          echo "ğŸ” æ£€æµ‹åˆ°åŒ…å: $pkg"
          if [ -z "$pkg" ]; then
            echo "::error::æ— æ³•ä» pubspec.yaml æ‰¾åˆ°åŒ…å"
            exit 1
          fi
          echo "pkg=$pkg" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆé¦–å­—æ¯å¤§å†™çš„åŒ…å
        id: pkg_capitalized
        run: |
          pkg="${{ steps.pkg.outputs.pkg }}"
          # å°†é¦–å­—æ¯è½¬æ¢ä¸ºå¤§å†™
          first_char=$(echo "${pkg:0:1}" | tr '[:lower:]' '[:upper:]')
          rest="${pkg:1}"
          pkg_capitalized="${first_char}${rest}"
          echo "âœ¨ é¦–å­—æ¯å¤§å†™åŒ…å: $pkg_capitalized"
          echo "pkg_capitalized=$pkg_capitalized" >> $GITHUB_OUTPUT

      - name: è¯»å–æˆ–ç”Ÿæˆç‰ˆæœ¬å·
        id: ver
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            version="${{ github.event.inputs.version }}"
            echo "ğŸ“ æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬: $version"
          else
            raw=$(grep '^version:' pubspec.yaml | awk '{print $2}')
            version="${raw%%+*}"
            echo "ğŸ“¦ ä» pubspec.yaml è¯»å–ç‰ˆæœ¬: $version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ç¡®å®š Tag åç§°
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            tag="v${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            tag="${{ github.ref_name }}"
          else
            tag="v${{ steps.ver.outputs.version }}"
          fi
          echo "ğŸ·ï¸ Tag åç§°: $tag"
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: è·å– Mihomo æ ¸å¿ƒç‰ˆæœ¬å·
        id: get_mihomo_version
        shell: pwsh
        run: |
          Write-Host "ğŸ“¡ æ­£åœ¨è·å– Mihomo æœ€æ–°ç‰ˆæœ¬å·..."
          try {
            $headers = @{
              "Accept" = "application/vnd.github+json"
              "X-GitHub-Api-Version" = "2022-11-28"
              "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
            }
            $response = Invoke-RestMethod -Uri "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" -Headers $headers
            $version = $response.tag_name -replace '^v', ''
            Write-Host "âœ… Mihomo æœ€æ–°ç‰ˆæœ¬: $version"
            echo "version=$version" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Host "âš ï¸ æœªèƒ½è·å– Mihomo ç‰ˆæœ¬å·ï¼Œå°†ä½¿ç”¨ 'æœªçŸ¥'"
            echo "version=æœªçŸ¥" >> $env:GITHUB_OUTPUT
          }

      - name: éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
        run: |
          tag_version="${{ steps.tag.outputs.tag }}"
          
          # ç§»é™¤ tag ä¸­çš„ 'v' å‰ç¼€
          tag_version_clean="${tag_version#v}"
          
          # å§‹ç»ˆä» pubspec.yaml è¯»å–å®é™…ç‰ˆæœ¬å·ï¼ˆä¸ä½¿ç”¨ç¼“å­˜çš„è¾“å‡ºï¼‰
          actual_pubspec_version=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          
          echo "ğŸ” ç‰ˆæœ¬å¯¹æ¯”ï¼š"
          echo "  Tag ç‰ˆæœ¬:           $tag_version_clean"
          echo "  pubspec.yaml ç‰ˆæœ¬:  $actual_pubspec_version"
          
          if [ "$tag_version_clean" != "$actual_pubspec_version" ]; then
            echo ""
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼"
            echo ""
            echo "æ¨é€çš„ tag ç‰ˆæœ¬ ($tag_version) ä¸ pubspec.yaml ä¸­çš„å®é™…ç‰ˆæœ¬ ($actual_pubspec_version) ä¸åŒ¹é…ã€‚"
            echo ""
            echo "è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š"
            echo "  1. æ›´æ–° pubspec.yaml ä¸­çš„ç‰ˆæœ¬å·ä¸º $tag_version_clean"
            echo "  2. åˆ é™¤å½“å‰ tag å¹¶æ¨é€æ­£ç¡®çš„ tag: v$actual_pubspec_version"
            echo ""
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          echo "ğŸ“ æ­£åœ¨ç”Ÿæˆæ›´æ–°æ—¥å¿—..."
          echo ""
          
          current_tag="${{ steps.tag.outputs.tag }}"
          
          # è·å–æ‰€æœ‰æ­£å¼ç‰ˆ tagï¼ˆæŒ‰ç‰ˆæœ¬å·é™åºï¼‰
          all_release_tags=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' || true)
          
          # æ’é™¤å½“å‰ tagï¼Œè·å–ä¸Šä¸€ä¸ªæ­£å¼ç‰ˆ
          previous_tag=$(echo "$all_release_tags" | grep -v "^${current_tag}$" | head -n 1 || true)
          
          if [ -z "$previous_tag" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ tagï¼Œä½¿ç”¨é¦–ä¸ªæäº¤"
            previous_tag=$(git rev-list --max-parents=0 HEAD)
          fi
          
          echo "ğŸ“ ç‰ˆæœ¬èŒƒå›´: $previous_tag â†’ $current_tag"
          echo ""
          
          # å®šä¹‰è¦å¿½ç•¥çš„æ–‡ä»¶è·¯å¾„æ¨¡å¼
          IGNORE_FILE_PATTERNS="^\.github/|^scripts/|\.yml$|\.yaml$|^README|^LICENSE|^\.gitignore|^\.metadata|^analysis_options\.yaml|^pubspec\.lock$"
          
          # ç”Ÿæˆæäº¤æ—¥å¿—
          {
            echo "## ğŸ“‹ æ›´æ–°æ—¥å¿—"
            echo ""
            echo "è‡ª $previous_tag ä»¥æ¥çš„åŠŸèƒ½å’Œä¿®å¤ï¼š"
            echo ""

            # è·å–æ‰€æœ‰æäº¤å¹¶å¤„ç†
            total_count=0
            filtered_count=0
            included_count=0
            
            # è·å–æ‰€æœ‰æäº¤å“ˆå¸Œ
            commit_hashes=$(git rev-list $previous_tag..HEAD --no-merges)
            
            # éå†æ¯ä¸ªæäº¤
            for hash in $commit_hashes; do
              total_count=$((total_count + 1))

              # è·å–æäº¤ä¿¡æ¯ï¼ˆæ ‡é¢˜å’Œæ­£æ–‡ï¼‰
              subject=$(git log -1 --pretty=format:"%s" "$hash")
              body=$(git log -1 --pretty=format:"%b" "$hash")

              # æ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦åŒ…å«"æ— ä½œç”¨"ç›¸å…³å…³é”®è¯ï¼ˆä¸­è‹±æ–‡ï¼‰
              # ä¸­æ–‡å…³é”®è¯ï¼š
              #   - æ—  X å˜åŒ–/å½±å“/æ”¹åŠ¨ï¼šæ— ä½œç”¨ã€æ— å½±å“ã€æ— æ•ˆæœã€æ— å®é™…ä½œç”¨ã€æ— åŠŸèƒ½å˜åŒ–ã€æ— åŠŸèƒ½å½±å“ã€æ— åŠŸèƒ½æ”¹åŠ¨ã€
              #     æ— é€»è¾‘å˜åŒ–ã€æ— é€»è¾‘æ”¹åŠ¨ã€æ— é€»è¾‘å½±å“ã€æ— è¡Œä¸ºå˜åŒ–ã€æ— è¡Œä¸ºæ”¹åŠ¨ã€æ— è¡Œä¸ºå½±å“ã€æ— ä¸šåŠ¡å˜åŒ–ã€æ— ä¸šåŠ¡å½±å“ã€
              #     æ— å®è´¨å˜åŒ–ã€æ— å®è´¨æ”¹åŠ¨
              #   - ä¸ X åŠŸèƒ½ï¼šä¸å½±å“ã€ä¸æ”¹å˜åŠŸèƒ½ã€ä¸å½±å“åŠŸèƒ½ã€ä¸æ¶‰åŠåŠŸèƒ½
              #   - ä»…/çº¯ Xï¼šä»…è°ƒæ•´ã€ä»…æ ¼å¼ã€ä»…é‡å‘½åã€ä»…å‘½åã€ä»…é‡æ„ã€çº¯é‡æ„ã€çº¯æ ¼å¼ã€çº¯æ ·å¼
              #   - X è°ƒæ•´ï¼šæ ¼å¼è°ƒæ•´ã€æ ·å¼è°ƒæ•´ã€ç©ºç™½è°ƒæ•´ã€æ³¨é‡Šè°ƒæ•´ã€å‘½åè°ƒæ•´ã€ç¼©è¿›è°ƒæ•´ã€å¯¼å…¥æ’åº
              #   - å…¶ä»–ï¼šæ— å…³ç´§è¦ã€æ— æ„ä¹‰ã€å‘½åè§„èŒƒã€å˜é‡å‘½åã€ä»£ç é£æ ¼ã€ä»£ç æ¸…ç†ã€ä»£ç æ•´ç†
              # è‹±æ–‡å…³é”®è¯ï¼š
              #   - no X changeï¼šno effectã€no impactã€no changeã€no functional changeã€no behavior changeã€
              #     no behavioural changeã€no logic change
              #   - X onlyï¼šformatting onlyã€style onlyã€comment onlyã€rename onlyã€refactor onlyã€cleanup only
              #   - å…¶ä»–ï¼šcosmeticã€whitespaceã€trivialã€code styleã€style fixã€lint fixã€lintingã€
              #     noopã€no-opã€reformatã€reformattingã€import sortã€organize imports
              if echo "$subject $body" | grep -qiE 'æ— ä½œç”¨|æ— å½±å“|æ— æ•ˆæœ|æ— å®é™…ä½œç”¨|æ— åŠŸèƒ½å˜åŒ–|æ— åŠŸèƒ½å½±å“|æ— åŠŸèƒ½æ”¹åŠ¨|æ— é€»è¾‘å˜åŒ–|æ— é€»è¾‘æ”¹åŠ¨|æ— é€»è¾‘å½±å“|æ— è¡Œä¸ºå˜åŒ–|æ— è¡Œä¸ºæ”¹åŠ¨|æ— è¡Œä¸ºå½±å“|æ— ä¸šåŠ¡å˜åŒ–|æ— ä¸šåŠ¡å½±å“|æ— å®è´¨å˜åŒ–|æ— å®è´¨æ”¹åŠ¨|ä¸å½±å“|ä¸æ”¹å˜åŠŸèƒ½|ä¸å½±å“åŠŸèƒ½|ä¸æ¶‰åŠåŠŸèƒ½|ä»…è°ƒæ•´|ä»…æ ¼å¼|ä»…é‡å‘½å|ä»…å‘½å|ä»…é‡æ„|çº¯é‡æ„|çº¯æ ¼å¼|çº¯æ ·å¼|æ ¼å¼è°ƒæ•´|æ ·å¼è°ƒæ•´|ç©ºç™½è°ƒæ•´|æ³¨é‡Šè°ƒæ•´|å‘½åè°ƒæ•´|ç¼©è¿›è°ƒæ•´|å¯¼å…¥æ’åº|æ— å…³ç´§è¦|æ— æ„ä¹‰|å‘½åè§„èŒƒ|å˜é‡å‘½å|ä»£ç é£æ ¼|ä»£ç æ¸…ç†|ä»£ç æ•´ç†|no effect|no impact|no change|no functional change|no behavior change|no behavioural change|no logic change|formatting only|style only|comment only|rename only|refactor only|cleanup only|cosmetic|whitespace|trivial|code style|style fix|lint fix|linting|noop|no-op|reformat|reformatting|import sort|organize imports'; then
                filtered_count=$((filtered_count + 1))
                continue
              fi

              # è·å–æäº¤æ¶‰åŠçš„æ–‡ä»¶åˆ—è¡¨
              changed_files=$(git diff-tree --no-commit-id --name-only -r "$hash")

              # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ–‡ä»¶éƒ½åŒ¹é…å¿½ç•¥æ¨¡å¼
              should_ignore=true
              for file in $changed_files; do
                if ! echo "$file" | grep -qE "$IGNORE_FILE_PATTERNS"; then
                  should_ignore=false
                  break
                fi
              done

              # å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯è¦å¿½ç•¥çš„ç±»å‹ï¼Œè·³è¿‡è¿™ä¸ªæäº¤
              if [ "$should_ignore" = true ]; then
                filtered_count=$((filtered_count + 1))
                continue
              fi

              included_count=$((included_count + 1))

              author=$(git log -1 --pretty=format:"%an" "$hash")
              
              # è¾“å‡ºæ ¼å¼åŒ–çš„æäº¤ä¿¡æ¯
              echo "### $subject"
              echo ""
              
              # å¦‚æœæœ‰æ­£æ–‡ï¼Œåˆ™è¾“å‡º
              if [ -n "$body" ]; then
                echo "$body"
                echo ""
              fi
              
              echo "**æäº¤**: [\`${hash:0:7}\`](https://github.com/${{ github.repository }}/commit/$hash) | **ä½œè€…**: $author"
              echo ""
            done
            

          } > changelog.md
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—é¢„è§ˆï¼š"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat changelog.md
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # è¾“å‡ºåˆ° GitHub Actionsï¼ˆä½¿ç”¨ base64 ç¼–ç é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
          changelog_base64=$(base64 -w 0 changelog.md)
          echo "changelog=$changelog_base64" >> $GITHUB_OUTPUT

  # ------------ æ„å»º jobï¼ˆä¾èµ– prepareï¼‰ ------------
  build:
    name: æ„å»º ${{ matrix.platform }}-${{ matrix.arch }}
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            arch: x64
          - platform: windows
            os: windows-11-arm
            arch: arm64
          - platform: linux
            os: ubuntu-22.04
            arch: x64
          - platform: linux
            os: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.os }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è¾“å‡ºæ„å»ºä¿¡æ¯
        shell: bash
        run: |
          echo "============================================"
          echo "ğŸ“¦ åŒ…å:        ${{ needs.prepare.outputs.pkg }}"
          echo "â« ç‰ˆæœ¬å·:      ${{ needs.prepare.outputs.version }}"
          echo "ğŸ·ï¸ Tag:         ${{ needs.prepare.outputs.tag }}"
          echo "ğŸ–¥ï¸ å¹³å°:        ${{ matrix.platform }}"
          echo "âš™ï¸ æ¶æ„:        ${{ matrix.arch }}"
          echo "============================================"

      - name: é…ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ (matrix.os == 'windows-11-arm' || matrix.os == 'ubuntu-24.04-arm') && 'master' || 'stable' }}
          
      - name: é…ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        shell: bash
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£…é¡¹ç›®ä¾èµ–..."
          if [ "$RUNNER_OS" = "Linux" ]; then
            echo "  â¤ å®‰è£… Linux æ„å»ºä¾èµ–..."
            sudo apt-get update
            sudo apt-get install -y libgtk-3-dev libappindicator3-dev adwaita-icon-theme-full libkeybinder-3.0-dev
            echo "  âœ… Linux ä¾èµ–å®‰è£…å®Œæˆ"
          fi
          echo "  â¤ å®‰è£… Flutter ä¸»é¡¹ç›®ä¾èµ–"
          flutter pub get
          echo "  â¤ å®‰è£… rinf_cli"
          cargo install rinf_cli
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å®‰è£…é¢„æ„å»ºè„šæœ¬ä¾èµ–
        run: dart pub get
        working-directory: scripts

      - name: è¿è¡Œé¢„æ„å»ºè„šæœ¬
        run: dart run scripts/prebuild.dart --installer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
        run: rinf gen

      - name: ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
        run: dart run slang

      - name: è¿è¡Œæ„å»ºè„šæœ¬
        run: dart run scripts/build.dart --with-installer

      - name: å¤åˆ¶æ„å»ºäº§ç‰©åˆ° dist
        shell: bash
        run: |
          echo "ğŸ“¦ æ­£åœ¨å¤åˆ¶æ„å»ºäº§ç‰©..."
          if [ "$RUNNER_OS" = "Windows" ]; then
            pwsh -c '
              New-Item -ItemType Directory -Force -Path dist | Out-Null
              if (Test-Path "build/packages") {
                Copy-Item -Path "build/packages/*" -Destination "dist/" -Recurse -Force
                Write-Host "âœ… æ„å»ºäº§ç‰©å·²å¤åˆ¶åˆ° dist/"
                Write-Host ""
                Write-Host "ğŸ“¦ äº§ç‰©åˆ—è¡¨:"
                Get-ChildItem -Path "dist/" | ForEach-Object {
                  $size = if ($_.PSIsContainer) { "ç›®å½•" } else { "$([math]::Round($_.Length / 1MB, 2)) MB" }
                  Write-Host "  - $($_.Name) ($size)"
                }
              } else {
                Write-Host "âŒ é”™è¯¯: build/packages ç›®å½•ä¸å­˜åœ¨"
                exit 1
              }
            '
          elif [ "$RUNNER_OS" = "Linux" ]; then
            mkdir -p dist
            if [ -d "build/packages" ]; then
              cp -r build/packages/* dist/
              echo "âœ… æ„å»ºäº§ç‰©å·²å¤åˆ¶åˆ° dist/"
              echo ""
              echo "ğŸ“¦ äº§ç‰©åˆ—è¡¨:"
              ls -lh dist/
            else
              echo "âŒ é”™è¯¯: build/packages ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.prepare.outputs.pkg }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/*
          retention-days: 90

  # ------------ åˆ›å»ºæ­£å¼å‘å¸ƒ ------------
  release:
    name: åˆ›å»ºæ­£å¼å‘å¸ƒ
    needs: [prepare, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    outputs:
      mihomo_version: ${{ steps.get_mihomo_version.outputs.version }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è§£ç æ›´æ–°æ—¥å¿—
        id: decode_changelog
        run: |
          echo "ğŸ“ æ­£åœ¨è§£ç æ›´æ–°æ—¥å¿—..."
          
          # ä» prepare job è·å– base64 ç¼–ç çš„æ›´æ–°æ—¥å¿—
          changelog_base64="${{ needs.prepare.outputs.changelog }}"
          
          if [ -n "$changelog_base64" ]; then
            # è§£ç  base64
            echo "$changelog_base64" | base64 -d > changelog.md
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“‹ è§£ç çš„æ›´æ–°æ—¥å¿—é¢„è§ˆï¼š"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cat changelog.md
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            # è¾“å‡ºåˆ° GitHub Actions
            {
              echo 'changelog<<EOF'
              cat changelog.md
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ›´æ–°æ—¥å¿—ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹"
            echo "changelog=## ğŸ“‹ æ›´æ–°æ—¥å¿—\n\næš‚æ— æ›´æ–°æ—¥å¿—ä¿¡æ¯ã€‚" >> $GITHUB_OUTPUT
          fi

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: ${{ needs.prepare.outputs.pkg_capitalized }} ${{ needs.prepare.outputs.version }} æ›´æ–°
          body: |
            ### ğŸ“¦ æ„å»ºä¿¡æ¯
            
            | é¡¹ç›® | å†…å®¹ |
            |------|------|
            | **åŒ…å** | `${{ needs.prepare.outputs.pkg }}` |
            | **ç‰ˆæœ¬å·** | `${{ needs.prepare.outputs.version }}` |
            | **Mihomo æ ¸å¿ƒ** | `${{ needs.prepare.outputs.mihomo_version }}` |
            
            ${{ steps.decode_changelog.outputs.changelog }}
            
            ---
            
            ## â“ æ•…éšœæ’æŸ¥

            ### Linux å¯åŠ¨é—®é¢˜

            å¦‚æœæ— æ³•å¯åŠ¨åº”ç”¨ï¼Œè¯·ç¡®ä¿å·²ä¸ºåº”ç”¨æ–‡ä»¶å¤¹èµ‹äºˆæƒé™ï¼š

            ```bash
            # è¿›å…¥åº”ç”¨ç›®å½•
            cd /path/to/stelliberty

            # èµ‹äºˆæƒé™
            chmod 777 -R ./stelliberty
            ```
            
            ### ç«¯å£è¢«å ç”¨ï¼ˆWindowsï¼‰
            
            å¦‚æœé‡åˆ°ç«¯å£å†²çªï¼š
            
            ```bash
            # 1. æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
            netstat -ano | findstr :ç«¯å£å·
            
            # 2. ç»“æŸè¿›ç¨‹ï¼ˆä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œï¼‰
            taskkill /F /PID XXX
            ```
            
            > âš ï¸ **é‡è¦**ï¼šå¿…é¡»ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œå‘½ä»¤æç¤ºç¬¦ã€‚æœåŠ¡æ¨¡å¼å¯åŠ¨çš„æ ¸å¿ƒè¿›ç¨‹éœ€è¦æå‡æƒé™æ‰èƒ½ç»ˆæ­¢ã€‚
            
            ### è½¯ä»¶å·¥ä½œä¸æ­£å¸¸
            
            **è·¯å¾„è¦æ±‚**ï¼ˆZIP å’Œ EXE å‡é€‚ç”¨ï¼‰ï¼š
            - è·¯å¾„ä¸­ä¸åº”åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆç©ºæ ¼é™¤å¤–ï¼‰
            - è·¯å¾„ä¸­ä¸åº”åŒ…å«é ASCII å­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡å­—ç¬¦ï¼‰
            - æ”¯æŒç©ºæ ¼ï¼š`D:\Program Files\Stelliberty` âœ…
            
            **EXE å®‰è£…ç¨‹åºçš„ä½ç½®é™åˆ¶**ï¼š
            
            å¦‚æœä½¿ç”¨ EXE å®‰è£…ç¨‹åºï¼Œè¿˜æœ‰é¢å¤–çš„å®‰è£…ä½ç½®é™åˆ¶ï¼š
            - **ç³»ç»Ÿç›˜ï¼ˆC:ï¼‰**ï¼šä»…å…è®¸ `%LOCALAPPDATA%\Programs\*`ï¼ˆå¦‚ `C:\Users\ç”¨æˆ·å\AppData\Local\Programs\Stelliberty`ï¼‰
            - **å…¶ä»–ç›˜ï¼ˆD:ã€E: ç­‰ï¼‰**ï¼šæ— é™åˆ¶
            
            > ğŸ’¡ å¦‚éœ€å®‰è£…åˆ° EXE ä¸å…è®¸çš„ä½ç½®ï¼Œè¯·ä½¿ç”¨**ä¾¿æºç‰ˆ ZIP**ï¼ˆæ— ä½ç½®é™åˆ¶ï¼Œä½†ä»å¯èƒ½å—ç³»ç»Ÿç›®å½•æƒé™å½±å“ï¼‰ã€‚
            
            ### ç¼ºå°‘è¿è¡Œåº“ï¼ˆWindowsï¼‰
            
            å¦‚æœåº”ç”¨ç¨‹åºåœ¨ Windows ä¸Šæ— æ³•å¯åŠ¨æˆ–ç«‹å³å´©æºƒï¼Œå¯èƒ½æ˜¯ç¼ºå°‘å¿…éœ€çš„ Visual C++ è¿è¡Œåº“ã€‚
            
            **è§£å†³æ–¹æ¡ˆï¼š**
            
            å®‰è£… Visual C++ è¿è¡Œåº“ï¼š[vcredist - Visual C++ è¿è¡Œåº“åˆé›†](https://gitlab.com/stdout12/vcredist)

          files: artifacts/**/*
          draft: false
          prerelease: false
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
