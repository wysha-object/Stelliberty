name: æµ‹è¯•ç‰ˆæ„å»º

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'
    paths-ignore:
      - '.github/workflows/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches:
      - '**'
    paths-ignore:
      - '.github/workflows/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ------------ æå‰å‡†å¤‡ï¼ˆè¯»å–åŒ…å & ç”Ÿæˆ tag & è¯»å–ç‰ˆæœ¬å·ï¼‰ ------------
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      datetime: ${{ steps.tag.outputs.datetime }}
      pkg: ${{ steps.pkg.outputs.pkg }}
      version: ${{ steps.ver.outputs.version }}
      commit_subject: ${{ steps.commit.outputs.subject }}
      commit_body: ${{ steps.commit.outputs.body }}
      commit_author: ${{ steps.commit.outputs.author }}
      commit_date: ${{ steps.commit.outputs.date }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è¯»å– pubspec.yaml åŒ…å
        id: pkg
        run: |
          pkg=$(grep '^name:' pubspec.yaml | awk '{print $2}')
          echo "ğŸ” æ£€æµ‹åˆ°åŒ…å: $pkg"
          if [ -z "$pkg" ]; then
            echo "::error::æ— æ³•ä» pubspec.yaml æ‰¾åˆ°åŒ…å"
            exit 1
          fi
          echo "pkg=$pkg" >> $GITHUB_OUTPUT

      - name: è¯»å– pubspec.yaml ä¸»ç‰ˆæœ¬å·
        id: ver
        run: |
          raw=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          echo "ğŸ” åŸå§‹ç‰ˆæœ¬å·: $raw"

          if [ -z "$raw" ]; then
            echo "::warning::æ— æ³•ä» pubspec.yaml æ‰¾åˆ° version å­—æ®µ"
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          fi

          version="${raw%%+*}"

          echo "ğŸ“¦ ä¸»ç‰ˆæœ¬å·: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        id: tag
        run: |
          datetime=$(date -u +"%Y%m%d%H%M")
          tag="v${datetime}"
          echo "â±ï¸ æ„å»ºæ—¶é—´: $datetime"
          echo "ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾: $tag"
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "datetime=$datetime" >> $GITHUB_OUTPUT

      - name: è·å–æäº¤ä¿¡æ¯
        id: commit
        run: |
          echo "ğŸ“ æ­£åœ¨è·å–å½“å‰æäº¤ä¿¡æ¯..."
          
          # è·å–å®Œæ•´çš„æäº¤æ¶ˆæ¯ï¼ˆæ ‡é¢˜ + æ­£æ–‡ï¼‰
          commit_subject=$(git log -1 --pretty=format:"%s")
          commit_body=$(git log -1 --pretty=format:"%b")
          commit_author=$(git log -1 --pretty=format:"%an")
          commit_date=$(git log -1 --pretty=format:"%ci")

          echo "ğŸ“ æäº¤ä¿¡æ¯ï¼š"
          echo "  æ ‡é¢˜: $commit_subject"
          echo "  ä½œè€…: $commit_author"
          echo "  æ—¶é—´: $commit_date"

          # ä½¿ç”¨ base64 ç¼–ç é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
          subject_base64=$(echo "$commit_subject" | base64 -w 0)
          body_base64=$(echo "$commit_body" | base64 -w 0)

          echo "subject=$subject_base64" >> $GITHUB_OUTPUT
          echo "body=$body_base64" >> $GITHUB_OUTPUT
          echo "author=$commit_author" >> $GITHUB_OUTPUT
          echo "date=$commit_date" >> $GITHUB_OUTPUT

  # ------------ æ„å»º jobï¼ˆä¾èµ– prepareï¼‰ ------------
  build:
    name: æ„å»º ${{ matrix.platform }}-${{ matrix.arch }}
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            arch: x64
          - platform: windows
            os: windows-11-arm
            arch: arm64
          - platform: linux
            os: ubuntu-24.04-arm
            arch: arm64
          - platform: linux
            os: ubuntu-22.04
            arch: x64
          - platform: macos
            os: macos-latest
            arch: arm64
    runs-on: ${{ matrix.os }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è¾“å‡ºæ„å»ºä¿¡æ¯
        run: |
          echo "============================================"
          echo "ğŸ“¦ åŒ…å:        ${{ needs.prepare.outputs.pkg }}"
          echo "â« ç‰ˆæœ¬å·:      ${{ needs.prepare.outputs.version }}"
          echo "ğŸ·ï¸ Tag:         ${{ needs.prepare.outputs.tag }}"
          echo "ğŸ•’ æ—¶é—´:        ${{ needs.prepare.outputs.datetime }}"
          echo "ğŸ–¥ï¸ å¹³å°:        ${{ matrix.platform }}"
          echo "âš™ï¸ æ¶æ„:        ${{ matrix.arch }}"
          echo "============================================"

      - name: é…ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ (matrix.os == 'windows-11-arm' || matrix.os == 'ubuntu-24.04-arm') && 'master' || 'stable' }}

      - name: é…ç½® Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        shell: bash
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£…é¡¹ç›®ä¾èµ–..."
          if [ "$RUNNER_OS" = "Linux" ]; then
            echo "  â¤ å®‰è£… Linux æ„å»ºä¾èµ–..."
            sudo apt-get update
            sudo apt-get install -y libgtk-3-dev libappindicator3-dev adwaita-icon-theme-full
            echo "  âœ… Linux ä¾èµ–å®‰è£…å®Œæˆ"
          fi
          if [ "$RUNNER_OS" = "macOS" ]; then
            echo "  â¤ å¯ç”¨ macOS æ¡Œé¢æ”¯æŒ..."
            flutter config --enable-macos-desktop
            echo "  âœ… macOS æ¡Œé¢æ”¯æŒå·²å¯ç”¨"
          fi
          echo "  â¤ å®‰è£… Flutter ä¸»é¡¹ç›®ä¾èµ–"
          flutter pub get
          echo "  â¤ å®‰è£… rinf_cli"
          cargo install rinf_cli
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å®‰è£…é¢„æ„å»ºè„šæœ¬ä¾èµ–
        run: dart pub get
        working-directory: scripts

      - name: è¿è¡Œé¢„æ„å»ºè„šæœ¬
        shell: bash
        run: |
          ARGS=""
          if [ "$RUNNER_OS" != "macOS" ]; then
            ARGS="--installer"
          fi
          dart run scripts/prebuild.dart $ARGS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
        run: rinf gen

      - name: ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
        run: dart run slang

      - name: è¿è¡Œæ„å»ºè„šæœ¬
        shell: bash
        run: |
          ARGS="--with-debug"
          if [ "$RUNNER_OS" != "macOS" ]; then
            ARGS="$ARGS --with-installer"
          fi
          dart run scripts/build.dart $ARGS

      - name: å¤åˆ¶æ„å»ºäº§ç‰©åˆ° dist
        shell: bash
        run: |
          echo "ğŸ“¦ æ­£åœ¨å¤åˆ¶æ„å»ºäº§ç‰©..."
          if [ "$RUNNER_OS" = "Windows" ]; then
            pwsh -c '
              New-Item -ItemType Directory -Force -Path dist | Out-Null
              if (Test-Path "build/packages") {
                Copy-Item -Path "build/packages/*" -Destination "dist/" -Recurse -Force
                Write-Host "âœ… æ„å»ºäº§ç‰©å·²å¤åˆ¶åˆ° dist/"
                Write-Host ""
                Write-Host "ğŸ“¦ äº§ç‰©åˆ—è¡¨:"
                Get-ChildItem -Path "dist/" | ForEach-Object {
                  $size = if ($_.PSIsContainer) { "ç›®å½•" } else { "$([math]::Round($_.Length / 1MB, 2)) MB" }
                  Write-Host "  - $($_.Name) ($size)"
                }
              } else {
                Write-Host "âŒ é”™è¯¯: build/packages ç›®å½•ä¸å­˜åœ¨"
                exit 1
              }
            '
          else
            mkdir -p dist
            if [ -d "build/packages" ]; then
              cp -r build/packages/* dist/
              echo "âœ… æ„å»ºäº§ç‰©å·²å¤åˆ¶åˆ° dist/"
              echo ""
              echo "ğŸ“¦ äº§ç‰©åˆ—è¡¨:"
              ls -lh dist/
            else
              echo "âŒ é”™è¯¯: build/packages ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.prepare.outputs.pkg }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/*
          retention-days: 7
          # æ·»åŠ å”¯ä¸€æ ‡è¯†ç¬¦ä»¥é¿å…ä¸åŒæ¶æ„é—´çš„æ–‡ä»¶åå†²çª
          if-no-files-found: warn

  # ------------ ä¸Šä¼ åˆ°å‘å¸ƒé¡µ ------------
  release:
    name: å‘å¸ƒæ„å»º
    needs: [prepare, build]
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è§£ç æäº¤ä¿¡æ¯
        id: decode_commit
        run: |
          echo "ğŸ“ æ­£åœ¨è§£ç æäº¤ä¿¡æ¯..."
          
          # ä» prepare job è·å– base64 ç¼–ç çš„æäº¤ä¿¡æ¯
          subject_base64="${{ needs.prepare.outputs.commit_subject }}"
          body_base64="${{ needs.prepare.outputs.commit_body }}"
          
          if [ -n "$subject_base64" ]; then
            # è§£ç  base64
            commit_subject=$(echo "$subject_base64" | base64 -d)
            echo "âœ… æäº¤æ ‡é¢˜: $commit_subject"
            
            # è¾“å‡ºåˆ° GitHub Actions
            {
              echo 'subject<<EOF'
              echo "$commit_subject"
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æäº¤æ ‡é¢˜"
            echo "subject=æœªçŸ¥æäº¤" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$body_base64" ]; then
            # è§£ç  base64
            commit_body=$(echo "$body_base64" | base64 -d)
            echo "âœ… æäº¤æ­£æ–‡å·²è§£ç "
            
            # è¾“å‡ºåˆ° GitHub Actions
            {
              echo 'body<<EOF'
              echo "$commit_body"
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æäº¤æ­£æ–‡"
            echo "body=" >> $GITHUB_OUTPUT
          fi

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: é¢„å‘å¸ƒæ„å»ºäº§ç‰©
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Beta ${{ needs.prepare.outputs.datetime }}
          body: |
            ## ğŸš€ Beta æµ‹è¯•ç‰ˆæœ¬
            
            > âš ï¸ è¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„æµ‹è¯•ç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨æœªçŸ¥é—®é¢˜ï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨ã€‚
            
            ### ğŸ“¦ æ„å»ºä¿¡æ¯
            
            | é¡¹ç›® | å†…å®¹ |
            |------|------|
            | **åŒ…å** | `${{ needs.prepare.outputs.pkg }}` |
            | **åº”ç”¨ç‰ˆæœ¬** | `${{ needs.prepare.outputs.version }}` |
            | **æ„å»ºæ—¶é—´** | ${{ needs.prepare.outputs.datetime }} (UTC) |
            | **æäº¤å“ˆå¸Œ** | [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |
            
            ### ğŸ“ æœ¬æ¬¡æ›´æ–°

            **æäº¤è€…**: ${{ needs.prepare.outputs.commit_author }}
            **æäº¤æ—¶é—´**: ${{ needs.prepare.outputs.commit_date }}

            **æäº¤æ ‡é¢˜**:
            ```
            ${{ steps.decode_commit.outputs.subject }}
            ```

            **æäº¤è¯¦æƒ…**:
            ```
            ${{ steps.decode_commit.outputs.body }}
            ```
            
            ---
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            
            æ”¯æŒå¹³å°ï¼š
            - **Windows**: `x64`, `arm64`
            - **Linux**: `amd64`, `arm64`
            - **macOS**: `arm64`
            
            æ‰€æœ‰æ„å»ºäº§ç‰©å·²æ‰“åŒ…ä¸Šä¼ ï¼Œè¯·æ ¹æ®éœ€è¦ä¸‹è½½ã€‚

          files: artifacts/**/*
          prerelease: true
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
